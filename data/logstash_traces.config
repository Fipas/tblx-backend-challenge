input {
  file {
    path => "/user/share/logstash/data/siri.20121111.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  csv {
    separator => ","
    columns => [
      "timestampUnix", 
      "lineId", 
      "direction", 
      "journeyPatternId",
      "timeframe",
      "vehicleJourneyId",
      "operator",
      "congestion",
      "longitude",
      "latitude",
      "delay",
      "blockId",
      "vehicleId",
      "stopId",
      "atStop"
    ]
  }

  mutate { gsub => ["timestampUnix", "\d{3}$", ""] }
  mutate { convert => ["timestampUnix", integer] }
  mutate { convert => ["lineId", integer] }
  mutate { convert => ["direction", "integer"] }
  mutate { convert => ["vehicleJourneyId", integer] }
  mutate { convert => ["congestion", "boolean"] }
  mutate { convert => ["longitude", "float"] }
  mutate { convert => ["latitude", "float"] }
  mutate { convert => ["delay", "integer"] }
  mutate { convert => ["blockId", "integer"] }
  mutate { convert => ["vehicleId", "integer"] }
  mutate { convert => ["stopId", "integer"] }
  mutate { convert => ["atStop", "boolean"] }

  date {
    timezone => "GMT"
    match => ["timestampUnix", "UNIX_MS"]
    target => "@timestamp"
  }

  date {
    timezone => "GMT"
    match => ["timeframe", "ISO8601"]
    target => "timeframe"
  }
}

output {
  elasticsearch {
    hosts => "http://elasticsearch:9200"
    index => "traces"
    document_type => "trace"
  }
  stdout {}
}
